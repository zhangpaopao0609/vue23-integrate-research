[toc]

# æ•´åˆ

## 1. èƒŒæ™¯

TD vue2 å’Œ vue3 ç‰ˆæœ¬ç›®å‰æ˜¯åœ¨ä¸¤ä¸ªä»“åº“ä¸‹ï¼Œå¼€å‘æˆ–æ›´æ–°æŸä¸ªç»„ä»¶æ—¶ï¼Œéœ€è¦åŒæ—¶å¯¹ä¸¤ä¸ªä»“åº“è¿›è¡Œä¿®æ”¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸æ˜¯å®Œå…¨ä¸åŒçš„ï¼Œç›¸åï¼Œåœ¨ç»å¤§å¤šæ•°æƒ…å½¢ï¼Œè¿™ä¸¤ä¸ªä»“åº“çš„æ”¹åŠ¨å‡ ä¹ä¸€è‡´ï¼Œäº›è®¸çš„å·®å¼‚åœ¨äºä¸¤ä¸ªéƒ¨åˆ†ï¼š

- jsx å†™æ³•ä¸Šçš„å·®å¼‚

- vue2 å’Œ vue3 æ¡†æ¶æ‰€å¸¦æ¥çš„ä¸€äº› API å’Œå®ä¾‹ä¸Šæ‰€æš´éœ²çš„å±æ€§ä¹‹é—´çš„å·®å¼‚

æ—¢ç„¶ vue2 å’Œ vue3 å¤§éƒ¨åˆ†å†…å®¹å‡ ä¹ä¸€è‡´ï¼Œ**é‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥ç”¨ä¸€å¥—ä»£ç æ¥åŒæ—¶å®ç° vue2 å’Œ vue3 å‘¢ï¼Ÿ**ç„¶åå°†å…¶èåˆåœ¨ä¸€ä¸ªä»“åº“é‡Œé¢ï¼Œæ—¢èƒ½é™ä½äº†ç»´æŠ¤çš„æˆæœ¬ï¼Œåˆèƒ½åŠ å¿«æ›´æ–°çš„é€Ÿåº¦ã€‚

å½“ç„¶ï¼Œvue2.7 å’Œ vue3 ä¹‹é—´çš„å·®å¼‚ç›¸å¯¹è¾ƒå°‘åŒæ—¶ vue2.7 å®Œå…¨å…¼å®¹äº† vue2.6ï¼ŒåŸºäºè¿™æ ·çš„ä¸€ä¸ªèƒŒæ™¯ï¼Œæˆ‘ä»¬å°è¯•æ¢ç´¢äº†å°† vue2.7 å’Œ vue3 æ•´åˆåˆ°ä¸€ä¸ªä»“åº“ä¸­çš„å®ç°æ–¹æ¡ˆã€‚

> å¦‚æ— ç‰¹åˆ«è¯´æ˜ï¼Œä¸‹æ–‡ä¸­çš„ vue23 å³æŒ‡ vue2.7 å’Œ vue3

TD ç›®å‰ vue2 å’Œ vue3 çš„ä»“åº“å‡ç›¸å¯¹å®Œå–„ï¼Œæ‰€ä»¥ä¸ºäº†å°½é‡å‡å°‘æ•´åˆçš„å·¥ä½œé‡ï¼Œæˆ‘ä»¬é€‰æ‹©ä»¥ vue3 åŸºç¡€è¯­æ³•å’Œ vue3 jsx å†™æ³•ä½œä¸ºåŸºç¡€ DSLï¼Œç„¶ååŸºäºæ­¤æ¥å®ç° vue2.7 çš„å…¼å®¹ã€‚

> å³ï¼švue3 ä»“åº“çš„å†™æ³•å°½é‡ä¿æŒä¸åŠ¨ï¼ŒåŸºäº vue3 æ¥å®ç° vue2.7

## 2. Vue23 çš„å·®å¼‚

è¦å®ç° vue23 å…±ç”¨ä¸€å¥—ä»£ç çš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯ï¼Œé€šè¿‡å„ç§æ‰‹æ®µæ¥ç£¨å¹³å®ƒä»¬ä¹‹é—´çš„å·®å¼‚ï¼Œé‚£ä¹ˆåœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è¯¦ç»†äº†è§£ä¸€ä¸‹å®ƒä»¬ä¹‹é—´å­˜åœ¨çš„å·®å¼‚ã€‚

### 2.1 jsx å†™æ³•ä¸Šçš„å·®å¼‚

1. props 

2. slots

3. on

   æ— æ³•ç©¿é€

### 2.2 API å·®å¼‚

 https://blog.vuejs.org/posts/vue-2-7-naruto

### 2.3 å®ä¾‹ä¸Šå±æ€§çš„å·®å¼‚

### 2.4 å†…ç½®ç»„ä»¶çš„å·®å¼‚

- Teleport
- Suspense

ä¸Šè¿°è¿™ 4 ç§å·®å¼‚åœ¨ TD vue ä¸­å‡å­˜åœ¨ï¼Œæˆ‘ä»¬å°†å…¶åˆ†ç±»ï¼Œå¯ä»¥åˆ†æˆä¸¤ç±»ï¼š

- ç¼–è¯‘æ—¶å·®å¼‚
- è¿è¡Œæ—¶å·®å¼‚

**å…¶ä¸­ jsx å†™æ³•å±äºç¼–è¯‘æ—¶çš„å·®å¼‚ï¼Œå…¶å®ƒçš„å±äºè¿è¡Œæ—¶çš„å·®å¼‚ã€‚**

> ä¸‹é¢æˆ‘ä»¬ä¼šè®¨è®ºæ–¹æ¡ˆï¼Œå…¶å®ä»è¿™é‡Œæˆ‘ä»¬å°±èƒ½å¤§æ¦‚æœ€è§£å†³æ–¹æ¡ˆæœ‰äº›è®¸çš„äº†è§£

## 3. æ–¹æ¡ˆæ¢ç´¢

åœ¨æœ€åˆçš„æ¢ç´¢é˜¶æ®µï¼Œæˆ‘ä»¬æå‡ºäº† 4 ç§æ–¹æ¡ˆï¼š

1. åŸºäºæºç çš„è½¬æ¢ï¼Œå³å°† vue3 çš„ä»£ç è½¬æ¢ä¸º vue2.7
2. åŸºäº AST çš„è½¬æ¢ï¼ŒåŒ 1ï¼Œåªæ˜¯è½¬æ¢çš„é˜¶æ®µä¸åŒ
3. render å‡½æ•°è½¬æ¢ï¼ŒåŒ 1ï¼Œåªæ˜¯è½¬æ¢çš„é˜¶æ®µä¸åŒ
4. ç¼–è¯‘å…¼å®¹ + è¿è¡Œæ—¶é€‚é…

### 3.1 ä»£ç è½¬æ¢

ä¸Šè¿°å‰ 3 ç§æ–¹æ¡ˆï¼Œæˆ‘ä»¬å°†å…¶ç»Ÿä¸€ç§°ä¸ºï¼šä»£ç è½¬æ¢ã€‚

åœ¨è¯¦ç»†ä»‹ç»è¿™ 3 ç§æ–¹æ¡ˆä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ vue çš„æ•´ä¸ªç”Ÿå‘½è¿‡ç¨‹ã€‚

<div align="center">
  <img src="../images/sfc-to-dom.png" alt="image-20230925172041578" style="zoom:36%;" />
  <p>
    å›¾1ï¼švue sfc-to-dom
  </p>
</div>



<div align="center">
  <img src="../images/sfc-ast-render-dom.png" alt="image-20230925172041578" style="zoom:36%;" />
  <p>
    å›¾2ï¼švue sfc-ast-render-dom
  </p>
</div>

æˆ‘ä»¬å†æ¥çœ‹ä»£ç è½¬æ¢çš„æ–¹æ¡ˆï¼šç®€å•åœ°è¯´ï¼Œ**å°±æ˜¯æŠŠ vue3 çš„ä»£ç è½¬æ¢æˆ vue2çš„**ã€‚å¬èµ·æ¥ä¼¼ä¹æ˜¯å¯è¡Œçš„å“ˆï¼Œè€Œä¸”ç¤¾åŒºä¹Ÿæœ‰ç±»ä¼¼çš„å·¥å…·ï¼Œæ¯”å¦‚ [gogocode](https://github.com/thx/gogocode) ï¼Œåªæ˜¯ gogocode æ˜¯å°† vue2 è½¬æ¢ä¸º vue3ã€‚ä½†çœŸçš„å¯è¡Œå—ï¼Ÿè¿™æ ·ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆæ¥çœ‹çœ‹è¿™ä¸‰ç§æ–¹æ¡ˆï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥çœ‹å“ˆï¼š



- æºç çš„è½¬æ¢

  ä¹Ÿå°±æ˜¯è¯´ï¼Œç›´æ¥å°† tsx/sfc æ–‡ä»¶å­—ç¬¦ä¸²è¿›è¡Œè½¬åŒ–â€”â€”SFC é˜¶æ®µè½¬æ¢ã€‚

  åˆæ­¥ä¸€æ€è€ƒï¼Œå°±èƒ½æƒ³åˆ°ï¼Œåº”è¯¥ä¼šä½¿ç”¨å¾ˆå¤šæ­£åˆ™ï¼Œè¯¸å¦‚xxxï¼Œå› æ­¤ï¼Œè¿™ç§æ–¹æ¡ˆä¼¼ä¹å¯è¡Œï¼Œä½†å› æ­£åˆ™æ›¿æ¢éš¾å…ä¼šé‡åˆ°é—æ¼æˆ–è€…åŒ¹é…é”™è¯¯çš„åœ°æ–¹ï¼Œè€Œä¸”ï¼Œè¿™ç§æ–¹æ¡ˆçš„å·¥ä½œé‡å¯æƒ³è€ŒçŸ¥ä¼šéå¸¸åœ°å¤§ã€‚

- AST è½¬æ¢

  æ‰€è°“ ASTï¼Œä¸è¿‡æ˜¯ tsx/sfc ç»è¿‡ç¼–è¯‘åå½¢æˆçš„ä¸€ä¸ªæ ‘å½¢å¯¹è±¡ï¼ˆä¸€èˆ¬ç”± babel ç¼–è¯‘ï¼‰ï¼Œç›¸æ¯”è¾ƒæ–¹æ¡ˆ 1 æºç è½¬æ¢ï¼ŒAST ä¼šç›¸å¯¹æ¥è¯´æ›´åŠ åœ°å‡†ç¡®ï¼Œç›¸å½“äº babel å¸®æˆ‘ä»¬åšäº†ä¸€äº›å‰ç½®çš„å·¥ä½œã€‚

- render å‡½æ•°è½¬æ¢

å› æ­¤ï¼Œè¿™ç§æ–¹æ¡ˆçš„å¯è¡Œæ€§è¾ƒå°ï¼Œæš‚ä¸”å®šä¸º â­ï¸

### 3.2 ç¼–è¯‘å…¼å®¹ + è¿è¡Œæ—¶é€‚é…

ç¬¬ 2 èŠ‚è¯¦ç»†æè¿°äº† vue23 çš„å·®å¼‚ï¼Œä¸¤å¤§ç±»

- ç¼–è¯‘æ—¶å·®å¼‚

  ç¼–è¯‘æ—¶çš„å·®å¼‚åœ¨ç¼–è¯‘é˜¶æ®µç£¨å¹³

- è¿è¡Œæ—¶å·®å¼‚

  è¿è¡Œæ—¶çš„å·®å¼‚åœ¨è¿è¡Œæ—¶ç£¨å¹³

## 4. è§£å†³ç¤ºä¾‹

æ—¢ç„¶é€‰æ‹©ä½¿ç”¨ ç¼–è¯‘å…¼å®¹ + è¿è¡Œæ—¶é€‚é…çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç¤ºä¾‹æ¥æ¢ç´¢å’Œå®éªŒã€‚

å‡è®¾ç»„ä»¶åº“æä¾›äº† `UserResume` è¿™æ ·çš„ä¸€ä¸ªç»„ä»¶ï¼Œç»„ä»¶æä¾›çš„èƒ½åŠ›ï¼š

- å±•ç¤ºç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯
- ç”¨æˆ·å¯è¾“å…¥æ±‚èŒæ„å‘
- ç”¨æˆ·å¯è‡ªå®šä¹‰æ’æ§½ `paopao` å’Œè‡ªå®šä¹‰äº‹ä»¶ `paopao`

```tsx
import { defineComponent, computed, PropType, ref, watch, toRefs, useVModel } from 'common';

import props from "./props.ts";
import BasicInfo from "./components/basic-info";
import EducationExperience from "./components/education-experience";
import OtherInfo from "./components/other-info";

import "./styles/index.less";

const UserResume = defineComponent({
  name: 'UserResume',
  props,
  setup(props, { slots, emit }) {
    const { value: valueProps, modelValue } = toRefs(props)

    const basicInfo = computed(() => ({
      name: props.name,
      age: props.age,
      gender: props.gender,
    }))
    
    const [value, setValue] = useVModel(valueProps, modelValue, null, props.onInput, 'value', 'input');

    const handleInput = (e: InputEvent) => {
      const target = e.target;
      setValue(target.value)
    }

    return () => (
      <div class="resume">
        <h2>æ±‚èŒæ„å‘</h2>
        <input
          value={value.value}
          onInput={handleInput}
          class="position"
          type="text"
          placeholder='è¯·è¾“å…¥æ±‚èŒæ„å‘'
        />
        <p>{ value.value }</p>
        <BasicInfo {...basicInfo.value} />
        <EducationExperience educationList={props.educationList} />
        <OtherInfo v-slots={{paopao: slots.paopao}} onPaopao={props.onPaopao}/>
      </div>
    )
  },
});

export default UserResume;
```

å¯ä»¥çœ‹åˆ°ï¼Œç»„ä»¶å†…éƒ¨ä½¿ç”¨çš„æ˜¯ vue3 jsx çš„å†™æ³•ï¼Œå…¶ä¸­ `useVModel` ç”¨äºç»Ÿä¸€ç®¡ç†ç»„ä»¶å—æ§å’Œéå—æ§çš„å¤„ç†ã€‚

æˆ‘ä»¬å°±åŸºäºæ­¤ç»„ä»¶æ¥æè¿°å¦‚ä½•è§£å†³ã€‚

> æ‰“åŒ…å·¥å…·ä»¥ vite ä¸¾ä¾‹

### 4.1 ç¼–è¯‘æ—¶å·®å¼‚

#### 4.1.1 props å†™æ³•çš„ç£¨å¹³

ä»¥ `<BasicInfo {...basicInfo.value} />` ä¸ºä¾‹

å…¶ä¸­ vue3 jsx å†™æ³•å¦‚ä¸Šï¼Œä½† vue2 jsx çš„å†™æ³•å¦‚ä¸‹ï¼š

```tsx
<BasicInfo props={basicInfo.value} />
```

é‚£ä¹ˆæœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è§£å†³å‘¢ï¼Ÿ

1. ç¼–è¯‘å‰æ­£åˆ™æ›¿æ¢

   å³ï¼Œåœ¨ç¼–è¯‘å‰å°† `<BasicInfo {...basicInfo.value} />` ç¼–è¯‘æˆ  vue2 jsx èƒ½è¯†åˆ«çš„è¯­æ³•ï¼Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦ç±»ä¼¼å¦‚ä¸‹çš„ transform å³å¯

   ```ts
   export const transformBeforePlugin = () => ({
     name: 'transform-before',
     transform(code, id) {
       const props = /\{\s*\.\.\.([^\s\}]+)\s*\}/g;
       code = code.replace(props, (match, capturedValue) => {
         return `props={ ${capturedValue} }`;
       });
   
       return code
     }
   })
   ```

   çœ‹èµ·æ¥ä¼¼ä¹æŒºç®€å•å°±èƒ½è§£å†³äº†ï¼Œä½†æ˜¯ï¼Œè¿™å¹¶ä¸å®Œç¾ï¼Œå› ä¸ºç®€å•åœ°æ­£åˆ™å¾ˆéš¾åˆ¤æ–­å½“å‰ `{...XXX}` æ‰€å¤„çš„ä½ç½®ï¼Œå‡å¦‚ç”¨æˆ·å°†è¿™æ ·çš„æ¨¡å¼å†™åœ¨äº† js æˆ–è€…æ–‡æœ¬ä¸­å‘¢ï¼Ÿ

   ```vue
   <div>æ‰©å±•å¯¹è±¡å¦‚ä¸‹ {...zhangpaopao}</div>
   ```

   è¿™æ ·å²‚ä¸æ˜¯ç›´æ¥ GGï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆå¹¶ä¸å®Œç¾

   > å½“ç„¶ï¼Œä½ å¯ä»¥è¯´æˆ‘ç”¨æ­£åˆ™æ¥é™åˆ¶ä¸€ä¸‹ä¸å°±å¥½äº†å—ï¼Ÿå¯ä»¥æ˜¯å¯ä»¥ï¼Œä½†æ˜¯æ‰€è¦è€ƒè™‘çš„æƒ…å†µæ˜¯å¾ˆéš¾è¦†ç›–å…¨é¢çš„ï¼Œè‡³å°‘ï¼Œä½ æ²¡æœ‰ babel ä¸“ä¸šğŸ˜¶ğŸ˜¶ğŸ˜¶

2. ç¼–è¯‘æ—¶å…¼å®¹

   å…ˆçœ‹ä¸€çœ¼ vue2 jsx å°† `<BasicInfo props={basicInfo.value} />` ç¼–è¯‘æˆä»€ä¹ˆæ ·å­å§

   ```js
   () => h("div", {
         "class": "resume"
       }, [h(BasicInfo, _mergeJSXProps([{}, {
         "props": basicInfo.value
       }]))])
   ```

   å¯ä»¥çœ‹åˆ°ï¼Œ`props={basicInfo.value}` æœ€ç»ˆåœ¨æ¸²æŸ“å‡½æ•°çš„ç¬¬äºŒå‚æ•°ä¸­ï¼Œ`{"props": basicInfo.value}`

   æˆ‘ä»¬å†æ¥çœ‹ vue2 jsx ä¼šå°† `<BasicInfo {...basicInfo.value} />` ç¼–è¯‘æˆä»€ä¹ˆæ ·å­å§

   ```js
   () => h("div", {
         "class": "resume"
       }, [h(BasicInfo, _mergeJSXProps([{}, basicInfo.value]))])
   ```

   å¯ä»¥çœ‹åˆ°ï¼Œå¤§è‡´éƒ½æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯å°† `{...basicInfo.value}` ç¼–è¯‘åˆ°äº†æ¸²æŸ“å‡½æ•°çš„ç¬¬äºŒå‚æ•°ä¸­ `basicInfo.value`

   é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°† vue2 jsx ä¼šå°† `{...basicInfo.value}` ç¼–è¯‘æˆ `{"props": basicInfo.value}` è¿™æ ·ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ vue2 çš„è¿è¡Œæ—¶ï¼ˆæ¸²æŸ“å™¨ï¼‰å°±èƒ½è®¤è¯†äº†å‘¢ï¼Ÿ

   é‚£ä¹ˆæ€ä¹ˆåšå‘¢ï¼Ÿè¿™å°±éœ€è¦äº†è§£ä¸¤ä¸ªåº“äº†

   - babelï¼šåŸºç¡€ç¼–è¯‘åº“
   - [@vue/babel-preset-jsx](https://www.npmjs.com/package/@vue/babel-preset-jsx)ï¼šè§£æ vue çš„ jsx

   æˆ‘ä»¬ç€é‡çœ‹ `@vue/babel-preset-jsx`ï¼Œå®ƒå°±æ˜¯ç”¨äºå°† vue2 jsx ç¼–è¯‘æˆæ¸²æŸ“å‡½æ•°çš„ï¼Œå› æ­¤æˆ‘ä»¬å°±åœ¨è¿™ä¸ªåº“é‡ŒåšåŠ¨ä½œå³å¯ã€‚

   ```js
         attributesArray.map(el => {
           if (el.type === 'vueSpread') {
             // !todo zhangpaopao: å°†æ‰€æœ‰ {...xxx} éƒ½ç¼–è¯‘æˆ props={xxx}
             return t.objectExpression([t.objectProperty(t.stringLiteral('props'), el.argument)]);
           } else {
             return transformAttributes(t, el)
           }
         }),
       )
   ```

   > https://github.com/vuejs/jsx-vue2/blob/dev/packages/babel-plugin-transform-vue-jsx/src/index.js 275-277 è¡Œ

#### 4.1.2 v-slots å†™æ³•çš„ç£¨å¹³

åŒæ ·æ¥çœ‹ç¤ºä¾‹ `<OtherInfo v-slots={{paopao: slots.paopao}} />`

åœ¨ vue2 jsx ä¸­ï¼Œslots çš„å†™æ³•åº”å¦‚ä¸‹ï¼š

```vue
<OtherInfo scopedSlots={{paopao: slots.paopao}} />
```

åŒæ ·åœ°ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç¼–è¯‘å‰æ­£åˆ™æ›¿æ¢ï¼Œä½†é—®é¢˜åŒæ ·ä¹Ÿå­˜åœ¨ã€‚

å› æ­¤ä»ç„¶é€‰æ‹©ç¼–è¯‘æ—¶å…¼å®¹ã€‚

vue2 jsx å°† `<OtherInfo scopedSlots={{paopao: slots.paopao}} />` ç¼–è¯‘æˆ 

```js
() => h("div", {
      "class": "resume"
    }, [h(OtherInfo, {
      "scopedSlots": {
        paopao: slots.paopao
      }
    })])
```

å°† `<OtherInfo v-slots={{paopao: slots.paopao}} />` ç¼–è¯‘æˆ 

```js
() => h("div", {
      "class": "resume"
    }, [h(OtherInfo, {
      "directives": [{
        name: "slots",
        value: {
          paopao: slots.paopao
        }
      }]
    })])
```

é‚£ä¹ˆæˆ‘ä»¬è¦åšçš„æ˜¯ä¸æ˜¯éå¸¸æ¸…æ™°äº†ï¼šå°±æ˜¯å°† `v-slots` è¿™ä¸ªæŒ‡ä»¤ç»™å®ƒç¼–è¯‘åˆ° h å‡½æ•°çš„ç¬¬äºŒå‚æ•°å¹¶ä¸”ä»¥ `scopedSlots` ä¸º key çš„å½¢å¼å³å¯

```js
    if (isDirective(name)) {
      // !todo zhangpaopao: å°† v-slots ç¼–è¯‘æˆ scopedSlots: {}
      if(name.slice(2) === 'slots') {
        attributes.scopedSlots = value;
        return;
      } else {
        name = kebabcase(name.substr(1))
        prefix = 'directives';
      }
    } else {
```

> https://github.com/vuejs/jsx-vue2/blob/dev/packages/babel-plugin-transform-vue-jsx/src/index.js 195-197 è¡Œ

#### 4.1.3 on äº‹ä»¶ç©¿é€

å…ˆç®€å•æè¿°ä¸€ä¸‹ä»€ä¹ˆæ˜¯ on äº‹ä»¶ç©¿é€

```jsx
<UserResume onPaopao={handlePaopao}/>
```

å¦‚ä¸Šç”¨æˆ·åœ¨ä½¿ç”¨ UserResume ç»„ä»¶æ—¶ï¼Œé€šè¿‡ onPaopao ä¼ é€’äº† handlePaopao

ç»„ä»¶å†…éƒ¨ï¼š

```jsx
<OtherInfo onPaopao={props.onPaopao}/>
```

ä»¥åŠï¼š

```jsx
const OtherInfo = defineComponent({
  name: 'OtherInfo',
  setup(props, { slots, emit }) {
    return () => (
      <div class="other-info" onClick={() => emit('paopao')}>
        <h2>å…¶å®ƒè‡ªå®šä¹‰</h2>
      </div>
    )
  },
});
```

åœ¨ vue3 jsx ä¸­ï¼Œå­ç»„ä»¶ç‚¹å‡»æ—¶è§¦å‘ `click` äº‹ä»¶ï¼Œè°ƒç”¨ `emit('paopao')`ï¼Œä»è€Œè§¦å‘ UserResume ç»„ä»¶åœ¨ OtherInfo ç»„ä»¶ä¸Šç›‘å¬çš„ `paopao` äº‹ä»¶ï¼Œåˆè§¦å‘ `props.onPaopao` å‡½æ•°ï¼Œä½¿å¾—æœ€ç»ˆç”¨æˆ·ä¼ é€’çš„ `handlePaopao` å‡½æ•°å¾—ä»¥æ‰§è¡Œã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°ï¼ŒOtherInfo ç»„ä»¶è§¦å‘çˆ¶ç»„ä»¶ç›‘å¬çš„äº‹ä»¶æ—¶ï¼Œæ˜¯ç›´æ¥ä½¿ç”¨çš„ props.onPaopaoï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ emit('paopao')ã€‚

ä½†åœ¨ vue2 jsx ä¸­ï¼Œå°±éœ€è¦è¿™ä¸ªä¸­é—´å±‚ emitã€‚

> ä½ å¯èƒ½ä¼šè¯´ï¼Œè¿™æ ·æœ‰ç‚¹æå‘€ï¼Œä½¿ç”¨ props.onPaopao å’Œ emit('paopao') æœ‰å•¥åŒºåˆ«å‘€ï¼Œä¸éƒ½æ˜¯ä¸€è¡Œä»£ç å—ï¼Ÿ
>
> å“ï¼Œå¦‚æœä½ çš„ç»„ä»¶ä»…æ”¯æŒç”¨æˆ· @paopao çš„æ–¹å¼ï¼Œé‚£ä¹ˆçš„ç¡®æ˜¯çš„ï¼Œæ²¡åŒºåˆ«ï¼Œä½†æ˜¯ï¼Œå¦‚æœä½ çš„ç»„ä»¶æ—¢æ”¯æŒ @paopao çš„æ–¹å¼åŒæ—¶åˆæ”¯æŒ onPaopao çš„æ–¹å¼ï¼Œè¿™å°±ä¸ä¸€æ ·äº†ã€‚å‡å¦‚ä¸¤ç§æ–¹å¼ä½ çš„ç»„ä»¶éƒ½æ”¯æŒï¼Œé‚£ä¹ˆåœ¨ vue3 é‡Œé¢ï¼Œä½ ä»…ä»…éœ€è¦å†™ä¸€ä¸ª `props.onPaopao` å°±èƒ½å®ç°äº†ï¼Œå› ä¸º vue3 ç¼–è¯‘æ—¶ä¼šå°† @paopao æ—¢ç¼–è¯‘åˆ° on ä¸­ï¼Œåˆç¼–è¯‘åˆ° props ä¸­ã€‚
>
> ```js
> function _sfc_render(_ctx, _cache, $props, $setup, $data, $options) {
>   const _component_UserResume = _resolveComponent("UserResume");
>   return _openBlock(), _createElementBlock("div", null, [
>     _createVNode(_component_UserResume, { onPaopao: _ctx.handlePaopao }, null, 8, ["onPaopao"])
>   ]);
> }
> ```
>
> è€Œ vue2 jsx ç¼–è¯‘æ—¶ï¼Œä»…ä»…ä¼šæŠŠ @paopao ç¼–è¯‘åˆ° on ä¸­ï¼Œè€Œä¸ä¼šç¼–è¯‘åˆ° props ä¸­
>
> ```js
> function render() {
>   var _vm = this, _c = _vm._self._c, _setup = _vm._self._setupProxy;
>   return _c("div", [_c("UserResume", { on: { "paopao": _vm.handlePaopao } })], 1);
> }
> ```
>
> æ‰€ä»¥ï¼Œè¦æƒ³åœ¨ vue2 jsx ä¸­æ—¢æ”¯æŒ @paopaoï¼Œåˆæ”¯æŒ onPaopaoï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨è§¦å‘æ—¶ï¼š
>
> ```
> emit('paopao')
> props.onPopao?.()
> ```

é‚£ä¹ˆæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•èƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¥½å§ï¼Œæœ‰çš„å“Ÿï¼Œæ—¢ç„¶ vue3 jsx æŠŠ @paopao æ—¢ç¼–è¯‘åˆ° on ä¸­ï¼Œåˆç¼–è¯‘åˆ° props ä¸­å°±èƒ½å®ç° props.onPaopao?.() ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ vue2 jsx æŒ‰ç…§åŒæ ·çš„åŠæ³•å°±ä¸€æ ·å¯ä»¥å‘¢ï¼Ÿæ‰€ä»¥å§ï¼Œå¾ˆç®€å•äº†å“Ÿ

```js
  // !todo zhangpaopao: å°† on å¢åŠ åˆ° props ä¸­
  if(prefix === 'on') {
    addAttribute(t, attributes, 'props', t.objectProperty(t.stringLiteral(cloneName), value))
  }
```

> https://github.com/vuejs/jsx-vue2/blob/dev/packages/babel-plugin-transform-vue-jsx/src/index.js 165-185 è¡Œ



è¿™é‡Œï¼Œä»…ä»…ç½—åˆ—äº† 3 ç§æƒ…å†µï¼Œå¯èƒ½è¿˜ä¼šå‡ºç°å…¶å®ƒçš„ jsx å†™æ³•ä¸Šçš„å·®å¼‚ï¼Œä½†æˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒï¼Œ**ç¼–è¯‘çš„é—®é¢˜ç”¨ç¼–è¯‘çš„æ‰‹æ®µè§£å†³å³å¯**ã€‚

### 4.2 è¿è¡Œæ—¶å·®å¼‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼Œä»€ä¹ˆæ˜¯è¿è¡Œæ—¶å·®å¼‚ã€‚

åœ¨ TD ä¸­ï¼Œç»„ä»¶çš„å®ä¾‹å¯¹è±¡æ˜¯å¸¸å¸¸è¢«ä½¿ç”¨çš„ï¼Œä¾‹å¦‚å®ä¾‹å¯¹è±¡ä¸Šçš„ slotsã€parent å±æ€§ã€‚TD ä¸­ä¸ºäº†ç»Ÿä¸€åœ°å¤„ç†æ’æ§½ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨ vue23 ä¸­å®ç°äº†ä¸€ä¸ª hooksï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

```js
function handleSlots(instance: ComponentInternalInstance, name: string, params: Record<string, any>) {
  const instance = getCurrentInstance();
  // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ é©¼å³°å‘½å çš„æ’æ§½ï¼ˆè¿‡æ»¤æ³¨é‡ŠèŠ‚ç‚¹ï¼‰
  let node = instance.slots[camelCase(name)]?.();
  if (node && node.filter((t) => t.type.toString() !== 'Symbol(v-cmt)').length) return node;
  // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ä¸­åˆ’çº¿å‘½å çš„æ’æ§½
  node = instance.slots[kebabCase(name)]?.();
  if (node && node.filter((t) => t.type.toString() !== 'Symbol(v-cmt)').length) return node;
  return null;
}
```

è¿™é‡Œä¸å…³æ³¨ç»†èŠ‚å“ˆã€‚å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼šä» instance.slots ä¸Šè·å–æ’æ§½å‡½æ•°ï¼Œè¿™æ˜¯ vue3 ç‰ˆæœ¬çš„

å†æ¥çœ‹ vue2 ç‰ˆæœ¬çš„ï¼š

```js
function handleSlots(name: string, params: Record<string, any>) {
  const instance = getCurrentInstance();
  // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ é©¼å³°å‘½å çš„æ’æ§½
  let node = instance._setupContext.slots[camelCase(name)]?.(finaleParams);
  if (node) return node;
  // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ä¸­åˆ’çº¿å‘½å çš„æ’æ§½
  node = instance._setupContext.slots[kebabCase(name)]?.(finaleParams);
  if (node) return node;
  return null;
}
```

